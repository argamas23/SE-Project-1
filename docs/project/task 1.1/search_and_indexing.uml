@startuml

package "search" {
    
    interface IndexManager {
        + initialize()
        + search(...) : SearchResultList
        + addEntryIndexOperation(WeblogEntry)
        + addEntryReIndexOperation(WeblogEntry)
        + rebuildWeblogIndex(WeblogEntry)
        + removeWeblogIndex(WeblogEntry)
        + removeEntryIndexOperation(WeblogEntry)
    }

    class SearchResultList {
        - limit: int
        - offset: int
        - categories: Set<String>
        - results: List<WeblogEntryWrapper>
        + getLimit() : int
        + getOffset() : int
        + getResults() : List<WeblogEntryWrapper>
        + getCategories() : Set<String>
    }

    class SearchResultMap {
        - limit: int
        - offset: int
        - categories: Set<String>
        - results: Map<Date, Set<WeblogEntryWrapper>>
        + getLimit() : int
        + getOffset() : int
        + getResults() : Map<Date, Set<WeblogEntryWrapper>>
        + getCategories() : Set<String>
    }

    package "lucene" {
        
        class LuceneIndexManager {
            - reader: IndexReader
            - roller: Weblogger
            - logger: Log
            - searchEnabled: boolean
            - indexDir: string
            - indexConsistencyMarker: File
            - inconsistentAtStartup: boolean
            - rwl: ReadWriteLock
            + getReadWriteLock(): ReadWriteLock
            + isInconsistentAtStartup(): boolean
            + getAnalyzer(): Analyzer
            - instantiateAnalyzer(): Analyzer
            - instantiateDefaultAnalyzer(): Analyzer
            + scheduleIndexOperation(IndexOperation)
            + executeIndexOperationNow(IndexOperation)
            + resetSharedReader()
            + getSharedIndexReader(): IndexReader
            + getIndexDirectory(): Directory
            + indexExists(): boolean
            + deleteIndex()
            + createIndex(Directory)
            + convertHitsToEntryList(...): SearchResultList
        }
        
        LuceneIndexManager .up.|> IndexManager : implements

        abstract class IndexOperation implements Runnable {
            # manager: LuceneIndexManager
            - writer: IndexWriter
            # getDocument(WeblogEntry) : Document
            # beginWriting() : IndexWriter
            # endWriting()
            + run()
            # doRun()
        }

        class FieldConstants {
            + ANCHOR : String
            + UPDATED : String
            + ID : String
            + USERNAME : String
            + CATEGORY : String
            + TITLE : String
            + PUBLISHED : String
            + CONTENT : String
            + CONTENT_STORED : String
            + C_CONTENT : String
            + C_EMAIL : String
            + C_NAME : String
            + CONSTANT : String
            + CONSTANT_V : String
            + WEBSITE_HANDLE : String
            + LOCALE : String
        }

        class IndexUtil {
            + getTerm(field, input): Term
        }

        abstract class ReadFromIndexOperation extends IndexOperation {
            - logger: Log
            + run()
        }

        abstract class WriteToIndexOperation extends IndexOperation {
            - logger: Log
            + run()
        }

        class SearchOperation extends ReadFromIndexOperation {
            - logger: Log
            - SEARCH_FIELDS: String
            - SORTER: Sort
            - searcher: IndexSearcher
            - searchresults: TopFieldDocs
            - term: String
            - weblogHandle: String
            - category: String
            - locale: String
            - parseError: String
            + setTerm(String term)
            + doRun()
            + getSearcher(): IndexSearcher
            + setSearcher(IndexSearcher searcher)
            + getResults(): TopFieldDocs
            + getResultsCount(): int
            + getParseError(): String
            + setWeblogHandle(String weblogHandle)
            + setCategory(String category)
            + setLocale(String locale)
        }

        class RebuildWebsiteIndexOperation extends WriteToIndexOperation {
            - logger: Log
            - website: Weblog
            - roller: Weblogger
            + doRun()
        }

        class RemoveWebsiteIndexOperation extends WriteToIndexOperation {
            - logger: Log
            - website: Weblog
            - roller: Weblogger
            + doRun()
        }

        class RemoveEntryOperation extends WriteToIndexOperation {
            - logger: Log
            - data: WeblogEntry
            - roller: Weblogger
            + doRun()
        }

        class ReIndexEntryOperation extends WriteToIndexOperation {
            - logger: Log
            - data: WeblogEntry
            - roller: Weblogger
            + doRun()
        }
        
        class AddEntryOperation extends WriteToIndexOperation {
            - logger: Log
            - data: WeblogEntry
            - roller: Weblogger
            + doRun()
        }
    }

    
    LuceneIndexManager *-- IndexOperation : schedules >
    
    LuceneIndexManager ..> SearchResultList : creates >
    LuceneIndexManager ..> SearchResultMap : creates >
    
    IndexManager ..> SearchResultList : returns >
    
    SearchOperation ..> SearchResultList : supplies data for >
    IndexOperation - FieldConstants
    SearchOperation ..> IndexUtil : creates terms >  
}
@enduml